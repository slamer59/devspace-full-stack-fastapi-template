version: v2beta1
name: fullstack-app

vars:
  DOMAIN:
    default: localhost
  POSTGRES_PASSWORD:
    default: changethis

images:
  backend:
    image: fastapi-backend
    dockerfile: ./backend/Dockerfile
    context: ./backend
    rebuildStrategy: ignoreContextChanges
    buildKit: {}
  frontend:
    image: react-frontend
    dockerfile: ./frontend/Dockerfile.dev
    context: ./frontend
    rebuildStrategy: ignoreContextChanges
    buildKit: {}

deployments:
  fullstack:
    kubectl:
      manifests:
        - k8s/base/shared/
        - k8s/base/backend/
        - k8s/base/frontend/
        - k8s/base/database/

dev:
  backend:
    imageSelector: fastapi-backend
    sync:
      - path: ./backend/app:/app/app
        excludePaths:
          - __pycache__/
          - "*.pyc"
    ports:
      - port: "8000"

  frontend:
    imageSelector: react-frontend
    sync:
      - path: ./frontend/src:/app/src
    ports:
      - port: "3000:5173"

  database:
    labelSelector:
      app: postgres-db
    ports:
      - port: "5432"

profiles:
  - name: backend-only
    patches:
      - op: remove
        path: dev.frontend
      - op: remove
        path: deployments.fullstack.kubectl.manifests[3]
